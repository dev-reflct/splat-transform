<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Working Browser Module Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .test-section {
                margin: 20px 0;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .success {
                background: #d4edda;
                border-color: #c3e6cb;
            }
            .error {
                background: #f8d7da;
                border-color: #f5c6cb;
            }
            #output {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 5px;
                white-space: pre-wrap;
                font-family: monospace;
                max-height: 400px;
                overflow-y: auto;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background: #0056b3;
            }
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
        </style>
    </head>
    <body>
        <h1>Working Browser Module Test</h1>

        <div class="test-section">
            <h2>Core Functionality Test</h2>
            <button onclick="testCoreFunctions()">Test Core Functions</button>
            <button onclick="testDataTable()">Test DataTable</button>
            <button onclick="testProcessing()">Test Processing</button>
        </div>

        <div class="test-section">
            <h2>File Operations Test</h2>
            <input type="file" id="testFile" accept=".ply,.splat,.ksplat" />
            <button onclick="testFileOperations()">Test File Operations</button>
            <button onclick="testSogsConversion()">Test SOGS Conversion</button>
        </div>

        <div class="test-section">
            <h2>Output</h2>
            <div id="output">Ready to test...</div>
        </div>

        <script type="module">
            let testResults = [];

            function log(message) {
                console.log(message);
                testResults.push(`[${new Date().toLocaleTimeString()}] ${message}`);
                document.getElementById('output').textContent = testResults.join('\n');
            }

            function clearLog() {
                testResults = [];
                document.getElementById('output').textContent = 'Ready to test...';
            }

            // Test core functions
            window.testCoreFunctions = async function () {
                clearLog();
                log('Testing core functions...');

                try {
                    // Test basic imports
                    const { DataTable, Column, processDataTable, combine, isGSDataTable } =
                        await import('../src/index-simple.ts');
                    log('‚úÖ Core imports successful');

                    // Test DataTable creation
                    const columns = [
                        new Column('x', new Float32Array([1, 2, 3])),
                        new Column('y', new Float32Array([4, 5, 6])),
                        new Column('z', new Float32Array([7, 8, 9])),
                    ];

                    const dataTable = new DataTable(columns);
                    log(
                        `‚úÖ DataTable created: ${dataTable.numRows} rows, ${dataTable.numColumns} columns`
                    );

                    // Test processing
                    const processed = processDataTable(dataTable, [{ kind: 'scale', value: 2.0 }]);
                    log('‚úÖ Processing successful');

                    // Test validation
                    const isValid = isGSDataTable(dataTable);
                    log(`‚úÖ Validation test: ${isValid ? 'Valid' : 'Invalid'} GS data`);

                    log('üéâ All core functions working!');
                } catch (error) {
                    log(`‚ùå Core functions test failed: ${error.message}`);
                    console.error('Core functions error:', error);
                }
            };

            // Test DataTable operations
            window.testDataTable = async function () {
                clearLog();
                log('Testing DataTable operations...');

                try {
                    const { DataTable, Column, combine } = await import('../src/index-simple.ts');

                    // Create multiple DataTables
                    const table1 = new DataTable([
                        new Column('x', new Float32Array([1, 2])),
                        new Column('y', new Float32Array([3, 4])),
                    ]);

                    const table2 = new DataTable([
                        new Column('x', new Float32Array([5, 6])),
                        new Column('y', new Float32Array([7, 8])),
                    ]);

                    log(`‚úÖ Created DataTable 1: ${table1.numRows} rows`);
                    log(`‚úÖ Created DataTable 2: ${table2.numRows} rows`);

                    // Test combining
                    const combined = combine([table1, table2]);
                    log(`‚úÖ Combined DataTable: ${combined.numRows} rows`);

                    log('üéâ DataTable operations working!');
                } catch (error) {
                    log(`‚ùå DataTable test failed: ${error.message}`);
                    console.error('DataTable error:', error);
                }
            };

            // Test processing functions
            window.testProcessing = async function () {
                clearLog();
                log('Testing processing functions...');

                try {
                    const { DataTable, Column, processDataTable } = await import(
                        '../src/index-simple.ts'
                    );

                    // Create test data
                    const dataTable = new DataTable([
                        new Column('x', new Float32Array([1, 2, 3])),
                        new Column('y', new Float32Array([4, 5, 6])),
                        new Column('z', new Float32Array([7, 8, 9])),
                    ]);

                    log('‚úÖ Created test DataTable');

                    // Test scale
                    const scaled = processDataTable(dataTable, [{ kind: 'scale', value: 2.0 }]);
                    log('‚úÖ Scale processing successful');

                    // Test translate
                    const translated = processDataTable(dataTable, [
                        { kind: 'translate', value: { x: 10, y: 20, z: 30 } },
                    ]);
                    log('‚úÖ Translate processing successful');

                    // Test filter
                    const filtered = processDataTable(dataTable, [{ kind: 'filterNaN' }]);
                    log('‚úÖ Filter processing successful');

                    log('üéâ All processing functions working!');
                } catch (error) {
                    log(`‚ùå Processing test failed: ${error.message}`);
                    console.error('Processing error:', error);
                }
            };

            // Test file operations
            window.testFileOperations = async function () {
                clearLog();
                log('Testing file operations...');

                const fileInput = document.getElementById('testFile');
                const file = fileInput.files[0];

                if (!file) {
                    log('‚ùå No file selected');
                    return;
                }

                log(`Selected file: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);

                try {
                    const { readPlyFromFile, readSplatFromFile, readKsplatFromFile } = await import(
                        '../src/index-simple.ts'
                    );

                    const filename = file.name.toLowerCase();
                    let result;

                    if (filename.endsWith('.ply')) {
                        result = await readPlyFromFile(file);
                        log('‚úÖ PLY file read successfully');
                    } else if (filename.endsWith('.splat')) {
                        result = await readSplatFromFile(file);
                        log('‚úÖ SPLAT file read successfully');
                    } else if (filename.endsWith('.ksplat')) {
                        result = await readKsplatFromFile(file);
                        log('‚úÖ KSPLAT file read successfully');
                    } else {
                        log('‚ùå Unsupported file type');
                        return;
                    }

                    if (result && result.elements && result.elements.length > 0) {
                        const dataTable = result.elements[0].dataTable;
                        log(
                            `‚úÖ File contains ${dataTable.numRows} rows and ${dataTable.numColumns} columns`
                        );
                        log(`Columns: ${dataTable.columnNames.join(', ')}`);
                    }

                    log('üéâ File operations working!');
                } catch (error) {
                    log(`‚ùå File operations failed: ${error.message}`);
                    console.error('File operations error:', error);
                }
            };

            // Test SOGS conversion
            window.testSogsConversion = async function () {
                clearLog();
                log('Testing SOGS conversion...');

                const fileInput = document.getElementById('testFile');
                const file = fileInput.files[0];

                if (!file) {
                    log('‚ùå No file selected');
                    return;
                }

                log(`Converting file: ${file.name}`);

                try {
                    const { convertSogs } = await import('../src/index-simple.ts');

                    const sogsData = await convertSogs(
                        file,
                        [{ kind: 'scale', value: 0.5 }],
                        5,
                        'cpu'
                    );

                    log('‚úÖ SOGS conversion successful!');
                    log(`Generated ${Object.keys(sogsData.files).length} files:`);
                    Object.keys(sogsData.files).forEach(filename => {
                        log(`  - ${filename}`);
                    });

                    log('üéâ SOGS conversion working!');
                } catch (error) {
                    log(`‚ùå SOGS conversion failed: ${error.message}`);
                    console.error('SOGS conversion error:', error);
                }
            };
        </script>
    </body>
</html>
