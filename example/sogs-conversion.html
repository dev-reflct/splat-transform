<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SOGS Conversion Example</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .section {
                margin: 20px 0;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background: #0056b3;
            }
            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            #output {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 5px;
                white-space: pre-wrap;
                font-family: monospace;
            }
            .progress {
                width: 100%;
                height: 20px;
                background: #f0f0f0;
                border-radius: 10px;
                overflow: hidden;
                margin: 10px 0;
            }
            .progress-bar {
                height: 100%;
                background: #007bff;
                width: 0%;
                transition: width 0.3s ease;
            }
        </style>
    </head>
    <body>
        <h1>SOGS Conversion Example</h1>

        <div class="section">
            <h2>Load File</h2>
            <input type="file" id="inputFile" accept=".ply,.splat,.ksplat" />
            <button onclick="loadFile()">Load File</button>
        </div>

        <div class="section">
            <h2>Processing Options</h2>
            <label> <input type="checkbox" id="enableProcessing" /> Enable Processing </label>
            <br />
            <label>
                Scale:
                <input type="number" id="scaleValue" value="1.0" step="0.1" min="0.1" max="10.0" />
            </label>
            <br />
            <label>
                Translate X: <input type="number" id="translateX" value="0" step="0.1" />
            </label>
            <br />
            <label>
                Translate Y: <input type="number" id="translateY" value="0" step="0.1" />
            </label>
            <br />
            <label>
                Translate Z: <input type="number" id="translateZ" value="0" step="0.1" />
            </label>
            <br />
            <label> <input type="checkbox" id="filterNaN" /> Filter NaN Values </label>
        </div>

        <div class="section">
            <h2>SOGS Options</h2>
            <label>
                Spherical Harmonics Iterations:
                <input type="number" id="shIterations" value="10" min="1" max="100" />
            </label>
            <br />
            <label>
                <input type="radio" name="shMethod" value="cpu" checked /> CPU Processing
            </label>
            <br />
            <label> <input type="radio" name="shMethod" value="gpu" /> GPU Processing </label>
        </div>

        <div class="section">
            <h2>Convert to SOGS</h2>
            <button onclick="convertToSogs()" id="convertBtn" disabled>Convert to SOGS</button>
            <div class="progress" id="progress" style="display: none">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div class="section">
            <h2>Output</h2>
            <div id="output">No file loaded yet.</div>
        </div>

        <script type="module">
            // Import the splat-transform module
            import { convertSogs } from '../dist/splat-transform.es.js';

            let currentFile = null;

            // Global functions for the buttons
            window.loadFile = function () {
                const fileInput = document.getElementById('inputFile');
                const file = fileInput.files[0];

                if (!file) {
                    updateOutput('Please select a file first.');
                    return;
                }

                currentFile = file;
                document.getElementById('convertBtn').disabled = false;
                updateOutput(
                    `Loaded file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`
                );
            };

            window.convertToSogs = async function () {
                if (!currentFile) {
                    updateOutput('No file loaded. Please load a file first.');
                    return;
                }

                try {
                    // Show progress
                    const progress = document.getElementById('progress');
                    const progressBar = document.getElementById('progressBar');
                    progress.style.display = 'block';
                    progressBar.style.width = '0%';

                    updateOutput('Starting SOGS conversion...');

                    // Build processing actions
                    const actions = [];
                    const enableProcessing = document.getElementById('enableProcessing').checked;

                    if (enableProcessing) {
                        const scale = parseFloat(document.getElementById('scaleValue').value);
                        if (scale !== 1.0) {
                            actions.push({ kind: 'scale', value: scale });
                        }

                        const translateX = parseFloat(document.getElementById('translateX').value);
                        const translateY = parseFloat(document.getElementById('translateY').value);
                        const translateZ = parseFloat(document.getElementById('translateZ').value);

                        if (translateX !== 0 || translateY !== 0 || translateZ !== 0) {
                            actions.push({
                                kind: 'translate',
                                value: { x: translateX, y: translateY, z: translateZ },
                            });
                        }

                        const filterNaN = document.getElementById('filterNaN').checked;
                        if (filterNaN) {
                            actions.push({ kind: 'filterNaN' });
                        }
                    }

                    // Get SOGS options
                    const shIterations = parseInt(document.getElementById('shIterations').value);
                    const shMethod = document.querySelector('input[name="shMethod"]:checked').value;

                    updateOutput('Converting to SOGS format...');
                    progressBar.style.width = '50%';

                    // Convert to SOGS
                    const sogsData = await convertSogs(
                        currentFile,
                        actions,
                        shIterations,
                        shMethod
                    );

                    progressBar.style.width = '100%';
                    updateOutput(
                        `SOGS conversion completed successfully!\n\nMeta data:\n${JSON.stringify(sogsData.meta, null, 2)}\n\nFiles generated:\n${Object.keys(sogsData.files).join('\n')}`
                    );

                    // Download the files
                    downloadSogsFiles(sogsData, currentFile.name);
                } catch (error) {
                    updateOutput(`Error during SOGS conversion: ${error.message}`);
                    console.error('SOGS conversion error:', error);
                } finally {
                    // Hide progress
                    document.getElementById('progress').style.display = 'none';
                }
            };

            function updateOutput(message) {
                document.getElementById('output').textContent = message;
            }

            function downloadSogsFiles(sogsData, originalFilename) {
                const baseName = originalFilename.replace(/\.[^/.]+$/, '');

                // Download meta.json
                const metaBlob = new Blob([JSON.stringify(sogsData.meta, null, 2)], {
                    type: 'application/json',
                });
                downloadBlob(metaBlob, `${baseName}_meta.json`);

                // Download all the WebP files
                Object.entries(sogsData.files).forEach(([filename, blob]) => {
                    downloadBlob(blob, filename);
                });

                updateOutput(`Downloaded SOGS files for: ${baseName}`);
            }

            function downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        </script>
    </body>
</html>
