<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SplatTransform Web Demo</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: #333;
                text-align: center;
                margin-bottom: 30px;
            }
            .upload-area {
                border: 2px dashed #ccc;
                border-radius: 10px;
                padding: 40px;
                text-align: center;
                margin: 20px 0;
                background: #fafafa;
                transition: all 0.3s ease;
            }
            .upload-area:hover {
                border-color: #007bff;
                background: #f0f8ff;
            }
            .upload-area.dragover {
                border-color: #007bff;
                background: #e6f3ff;
            }
            .file-input {
                display: none;
            }
            .btn {
                background: #007bff;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px;
            }
            .btn:hover {
                background: #0056b3;
            }
            .btn:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            .options {
                margin: 20px 0;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 6px;
            }
            .option-group {
                margin: 10px 0;
            }
            label {
                display: inline-block;
                width: 120px;
                font-weight: bold;
            }
            input[type='number'],
            input[type='text'] {
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                width: 100px;
            }
            .status {
                margin: 20px 0;
                padding: 15px;
                border-radius: 6px;
                display: none;
            }
            .status.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .status.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .status.info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
            .progress {
                width: 100%;
                height: 20px;
                background: #e9ecef;
                border-radius: 10px;
                overflow: hidden;
                margin: 10px 0;
            }
            .progress-bar {
                height: 100%;
                background: #007bff;
                width: 0%;
                transition: width 0.3s ease;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üß™ SplatTransform Web Demo</h1>

            <div class="upload-area" id="uploadArea">
                <p>üìÅ Drop a PLY file here or click to select</p>
                <input type="file" id="fileInput" class="file-input" accept=".ply,.splat,.ksplat" />
            </div>

            <div class="options">
                <h3>üîß Processing Options</h3>

                <div class="option-group">
                    <label>Scale:</label>
                    <input type="number" id="scale" value="1.0" step="0.1" min="0.1" max="10" />
                </div>

                <div class="option-group">
                    <label>Translate X:</label>
                    <input type="number" id="translateX" value="0" step="0.1" />
                    <label>Y:</label>
                    <input type="number" id="translateY" value="0" step="0.1" />
                    <label>Z:</label>
                    <input type="number" id="translateZ" value="0" step="0.1" />
                </div>

                <div class="option-group">
                    <label>Rotate X:</label>
                    <input type="number" id="rotateX" value="0" step="1" />
                    <label>Y:</label>
                    <input type="number" id="rotateY" value="0" step="1" />
                    <label>Z:</label>
                    <input type="number" id="rotateZ" value="0" step="1" />
                </div>

                <div class="option-group">
                    <label>Output Format:</label>
                    <select id="outputFormat">
                        <option value="compressed.ply">Compressed PLY</option>
                        <option value="json">SOGS (JSON)</option>
                        <option value="ply">PLY</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>

                <div class="option-group">
                    <label> <input type="checkbox" id="filterNaN" /> Filter NaN values </label>
                </div>
            </div>

            <button class="btn" id="processBtn" onclick="processFile()" disabled>
                üöÄ Process File
            </button>

            <div class="status" id="status"></div>
            <div class="progress" id="progress" style="display: none">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <script type="module">
            import {
                convertSogs,
                processDataTable,
                readPlyFromFile,
                readSplatFromFile,
                readKsplatFromFile,
                writePlyToBlob,
                writeCompressedPlyToBlob,
                writeCsvToBlob,
            } from './src/index.ts';

            let selectedFile = null;

            // File upload handling
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const processBtn = document.getElementById('processBtn');
            const status = document.getElementById('status');

            function showStatus(message, type = 'info') {
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = 'block';
            }

            function updateProgress(percent) {
                const progress = document.getElementById('progress');
                const progressBar = document.getElementById('progressBar');
                progress.style.display = 'block';
                progressBar.style.width = percent + '%';
            }

            // Drag and drop
            uploadArea.addEventListener('dragover', e => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', e => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    selectedFile = files[0];
                    showStatus(`üìÅ Selected: ${selectedFile.name}`, 'success');
                    processBtn.disabled = false;
                }
            });

            // File input change
            fileInput.addEventListener('change', e => {
                const files = e.target.files;
                if (files.length > 0) {
                    selectedFile = files[0];
                    showStatus(`üìÅ Selected: ${selectedFile.name}`, 'success');
                    processBtn.disabled = false;
                }
            });

            // Click to upload
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // Process file
            window.processFile = async () => {
                if (!selectedFile) {
                    showStatus('‚ùå Please select a file first', 'error');
                    return;
                }

                try {
                    processBtn.disabled = true;
                    showStatus('üîÑ Processing file...', 'info');
                    updateProgress(10);

                    const actions = [];

                    // Add scale action
                    const scale = parseFloat(document.getElementById('scale').value);
                    if (scale !== 1.0) {
                        actions.push({ kind: 'scale', value: scale });
                    }

                    // Add translate action
                    const translateX = parseFloat(document.getElementById('translateX').value);
                    const translateY = parseFloat(document.getElementById('translateY').value);
                    const translateZ = parseFloat(document.getElementById('translateZ').value);
                    if (translateX !== 0 || translateY !== 0 || translateZ !== 0) {
                        actions.push({
                            kind: 'translate',
                            value: { x: translateX, y: translateY, z: translateZ },
                        });
                    }

                    // Add rotate action
                    const rotateX = parseFloat(document.getElementById('rotateX').value);
                    const rotateY = parseFloat(document.getElementById('rotateY').value);
                    const rotateZ = parseFloat(document.getElementById('rotateZ').value);
                    if (rotateX !== 0 || rotateY !== 0 || rotateZ !== 0) {
                        actions.push({
                            kind: 'rotate',
                            value: { x: rotateX, y: rotateY, z: rotateZ },
                        });
                    }

                    // Add filter action
                    if (document.getElementById('filterNaN').checked) {
                        actions.push({ kind: 'filterNaN' });
                    }

                    const outputFormat = document.getElementById('outputFormat').value;
                    const outputFilename =
                        selectedFile.name.replace(/\.[^/.]+$/, '') + '_processed';

                    updateProgress(30);

                    let result;
                    if (outputFormat === 'json') {
                        // SOGS format
                        result = await convertSogs(selectedFile, actions);
                    } else {
                        // Read file first
                        const filename = selectedFile.name.toLowerCase();
                        let dataTable;

                        if (filename.endsWith('.ply')) {
                            const plyData = await readPlyFromFile(selectedFile);
                            dataTable = plyData.elements[0].dataTable;
                        } else if (filename.endsWith('.splat')) {
                            const splatData = await readSplatFromFile(selectedFile);
                            dataTable = splatData.elements[0].dataTable;
                        } else if (filename.endsWith('.ksplat')) {
                            const ksplatData = await readKsplatFromFile(selectedFile);
                            dataTable = ksplatData.elements[0].dataTable;
                        } else {
                            throw new Error(`Unsupported file type: ${filename}`);
                        }

                        // Process data
                        const processedDataTable = processDataTable(dataTable, actions);

                        // Write output
                        let outputData;
                        if (outputFormat === 'ply') {
                            outputData = await writePlyToBlob({
                                elements: [{ dataTable: processedDataTable }],
                            });
                        } else if (outputFormat === 'compressed.ply') {
                            outputData = await writeCompressedPlyToBlob(processedDataTable);
                        } else if (outputFormat === 'csv') {
                            outputData = await writeCsvToBlob(processedDataTable);
                        } else {
                            throw new Error(`Unsupported output format: ${outputFormat}`);
                        }

                        result = {
                            outputFormat,
                            outputData,
                            inputRows: dataTable.numRows,
                            outputRows: processedDataTable.numRows,
                            actionsApplied: actions.length,
                        };
                    }

                    console.log(result);

                    updateProgress(90);

                    // Handle different output formats
                    if (result.outputFormat === 'json') {
                        // SOGS format returns multiple files
                        const files = result.files;
                        const meta = result.meta;

                        // Create a zip-like structure or download individual files
                        for (const [filename, data] of Object.entries(files)) {
                            const isJson = filename.endsWith('.json');

                            const blob = new Blob([data], {
                                type: isJson ? 'application/json' : 'image/webp',
                            });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = isJson ? `${outputFilename}.${filename}` : filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }

                        showStatus(
                            `‚úÖ SOGS export complete! Generated ${Object.keys(files).length} files:
                            ${Object.keys(files).join(', ')}`,
                            'success'
                        );
                    } else {
                        // Single file formats (PLY, CSV)
                        const blob = new Blob([result.outputData], {
                            type: 'application/octet-stream',
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = outputFilename + '.' + result.outputFormat;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }

                    updateProgress(100);

                    showStatus(
                        `‚úÖ Processing complete! 
                    Input: ${result.inputRows} splats ‚Üí Output: ${result.outputRows} splats
                    Actions applied: ${result.actionsApplied}
                    Format: ${result.outputFormat}`,
                        'success'
                    );
                } catch (error) {
                    showStatus(`‚ùå Error: ${error.message}`, 'error');
                    console.error('Processing error:', error);
                } finally {
                    processBtn.disabled = false;
                    setTimeout(() => {
                        document.getElementById('progress').style.display = 'none';
                    }, 2000);
                }
            };
        </script>
    </body>
</html>
